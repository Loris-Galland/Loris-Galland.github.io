<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Carte IA - Contr√¥le par Gestes</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- TensorFlow.js et HandPose -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose@0.0.7/dist/handpose.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #map {
            position: fixed;
            inset: 0;
            z-index: 1;
        }

        #hud {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 10px;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            padding: 15px;
            width: 340px;
            max-width: 90vw;
        }

        #hud h2 {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #4a9eff;
        }

        .info-line {
            margin: 8px 0;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }

        .info-line label {
            color: #ccc;
        }

        .info-line span {
            color: #4a9eff;
            font-weight: bold;
        }

        #video-container {
            margin-top: 12px;
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        video {
            width: 100%;
            display: block;
            transform: scaleX(-1);
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
            pointer-events: none;
        }

        #status {
            margin-top: 10px;
            padding: 10px;
            background: rgba(74, 158, 255, 0.2);
            border-radius: 6px;
            border-left: 3px solid #4a9eff;
            font-size: 0.85rem;
        }

        .gesture-hint {
            margin-top: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            font-size: 0.75rem;
            color: #aaa;
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 10px;
            color: white;
            text-align: center;
            z-index: 1000;
        }

        #loading.hidden {
            display: none;
        }

        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #4a9eff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .controls {
            margin-top: 10px;
        }

        .controls button {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .controls button:hover {
            background: #005fa3;
        }

        .back-link {
            position: fixed;
            top: 10px;
            left: 10px;
            color: #4a9eff;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid #007acc;
            border-radius: 6px;
            z-index: 10;
        }

        .back-link:hover {
            background: #007acc;
            color: white;
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-link">‚Üê Retour</a>

    <div id="map"></div>

    <div id="hud">
        <h2>ü§ñ Contr√¥le IA par Gestes</h2>
        
        <div class="info-line">
            <label>Position:</label>
            <span id="coords">‚Äî</span>
        </div>
        <div class="info-line">
            <label>Zoom:</label>
            <span id="zoom">‚Äî</span>
        </div>
        <div class="info-line">
            <label>Main d√©tect√©e:</label>
            <span id="handStatus">Non</span>
        </div>

        <div id="video-container">
            <video id="camera" autoplay playsinline muted></video>
            <canvas id="canvas"></canvas>
        </div>

        <div id="status">
            En attente de gestes...
        </div>

        <div class="gesture-hint">
            <strong>Gestes:</strong><br>
            ‚Ä¢ Poing ferm√© = Zoom avant<br>
            ‚Ä¢ Main ouverte = Zoom arri√®re<br>
            ‚Ä¢ D√©placer la main = D√©placer la carte
        </div>

        <div class="controls">
            <button onclick="resetMap()">R√©initialiser la carte</button>
            <button onclick="toggleDetection()">Pause/Reprendre</button>
        </div>
    </div>

    <div id="loading">
        <h2>Chargement...</h2>
        <div class="spinner"></div>
        <p>Initialisation des mod√®les IA</p>
    </div>

    <script>
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        
        let map;
        let video, canvas, ctx;
        let handposeModel;
        let isDetecting = true;
        let lastGesture = null;
        let lastGestureTime = 0;
        const GESTURE_COOLDOWN = 800; // ms

        // Position de r√©f√©rence pour d√©placement
        let referenceHandPos = null;
        let lastMoveTime = 0;
        const MOVE_COOLDOWN = 500;

        // ============================================
        // INITIALISATION DE LA CARTE
        // ============================================

        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                scrollWheelZoom: false,
                doubleClickZoom: false,
                dragging: false,
                touchZoom: false
            }).setView([48.8566, 2.3522], 5);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Mettre √† jour les infos
            map.on('move zoom', updateMapInfo);
            updateMapInfo();

            // Ajouter quelques marqueurs de pays
            addCountryMarkers();
        }

        function updateMapInfo() {
            const center = map.getCenter();
            document.getElementById('coords').textContent = 
                `${center.lat.toFixed(4)}¬∞, ${center.lng.toFixed(4)}¬∞`;
            document.getElementById('zoom').textContent = map.getZoom();
        }

        function addCountryMarkers() {
            const countries = [
                { name: 'France', coords: [48.8566, 2.3522] },
                { name: 'USA', coords: [38.9072, -77.0369] },
                { name: 'UK', coords: [51.5074, -0.1278] },
                { name: 'Allemagne', coords: [52.52, 13.405] },
                { name: 'Italie', coords: [41.9028, 12.4964] },
                { name: 'Espagne', coords: [40.4168, -3.7038] },
                { name: 'Japon', coords: [35.6762, 139.6503] },
                { name: 'Canada', coords: [45.4215, -75.6972] },
                { name: 'Br√©sil', coords: [-15.7939, -47.8828] },
                { name: 'Chine', coords: [39.9042, 116.4074] }
            ];

            countries.forEach(country => {
                L.marker(country.coords)
                    .addTo(map)
                    .bindPopup(`<b>${country.name}</b>`);
            });
        }

        // ============================================
        // INITIALISATION DE LA CAM√âRA
        // ============================================

        async function initCamera() {
            video = document.getElementById('camera');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'user',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };

                return true;
            } catch (error) {
                console.error('Erreur cam√©ra:', error);
                alert('Impossible d\'acc√©der √† la cam√©ra. Autorisez l\'acc√®s.');
                return false;
            }
        }

        // ============================================
        // CHARGEMENT DU MOD√àLE HANDPOSE
        // ============================================

        async function loadHandposeModel() {
            try {
                console.log('Chargement du mod√®le Handpose...');
                handposeModel = await handpose.load();
                console.log('Mod√®le Handpose charg√© avec succ√®s');
                return true;
            } catch (error) {
                console.error('Erreur chargement mod√®le:', error);
                alert('Erreur lors du chargement du mod√®le IA');
                return false;
            }
        }

        // ============================================
        // D√âTECTION DES GESTES
        // ============================================

        async function detectHands() {
            if (!isDetecting || !handposeModel || !video.videoWidth) {
                requestAnimationFrame(detectHands);
                return;
            }

            try {
                const predictions = await handposeModel.estimateHands(video);
                
                // Effacer le canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (predictions.length > 0) {
                    const hand = predictions[0];
                    document.getElementById('handStatus').textContent = 'Oui';
                    
                    // Dessiner les points de la main
                    drawHand(hand);
                    
                    // Analyser le geste
                    analyzeGesture(hand);
                } else {
                    document.getElementById('handStatus').textContent = 'Non';
                    referenceHandPos = null;
                }
            } catch (error) {
                console.error('Erreur d√©tection:', error);
            }

            requestAnimationFrame(detectHands);
        }

        function drawHand(hand) {
            const landmarks = hand.landmarks;
            
            // Dessiner les points
            ctx.fillStyle = '#00ff00';
            landmarks.forEach(point => {
                ctx.beginPath();
                ctx.arc(point[0], point[1], 5, 0, 2 * Math.PI);
                ctx.fill();
            });

            // Dessiner les connexions
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            
            // Connexions des doigts
            const fingers = [
                [0, 1, 2, 3, 4],      // Pouce
                [0, 5, 6, 7, 8],      // Index
                [0, 9, 10, 11, 12],   // Majeur
                [0, 13, 14, 15, 16],  // Annulaire
                [0, 17, 18, 19, 20]   // Auriculaire
            ];

            fingers.forEach(finger => {
                for (let i = 0; i < finger.length - 1; i++) {
                    const point1 = landmarks[finger[i]];
                    const point2 = landmarks[finger[i + 1]];
                    
                    ctx.beginPath();
                    ctx.moveTo(point1[0], point1[1]);
                    ctx.lineTo(point2[0], point2[1]);
                    ctx.stroke();
                }
            });
        }

        function analyzeGesture(hand) {
            const landmarks = hand.landmarks;
            const now = Date.now();

            // Calculer si la main est ferm√©e ou ouverte
            const isHandClosed = detectHandClosed(landmarks);
            
            // Geste de zoom
            if (now - lastGestureTime > GESTURE_COOLDOWN) {
                if (isHandClosed && lastGesture !== 'closed') {
                    map.zoomIn();
                    updateStatus('üîé Zoom avant (poing ferm√©)');
                    lastGesture = 'closed';
                    lastGestureTime = now;
                } else if (!isHandClosed && lastGesture !== 'open') {
                    map.zoomOut();
                    updateStatus('üîç Zoom arri√®re (main ouverte)');
                    lastGesture = 'open';
                    lastGestureTime = now;
                }
            }

            // D√©placement bas√© sur la position de la paume
            handleHandMovement(landmarks, now);
        }

        function detectHandClosed(landmarks) {
            // V√©rifier si les doigts sont pli√©s
            const thumbTip = landmarks[4];
            const indexTip = landmarks[8];
            const middleTip = landmarks[12];
            const palmBase = landmarks[0];

            // Distance entre le pouce et l'index
            const thumbIndexDist = Math.sqrt(
                Math.pow(thumbTip[0] - indexTip[0], 2) + 
                Math.pow(thumbTip[1] - indexTip[1], 2)
            );

            // Distance entre la paume et le majeur
            const palmMiddleDist = Math.sqrt(
                Math.pow(palmBase[0] - middleTip[0], 2) + 
                Math.pow(palmBase[1] - middleTip[1], 2)
            );

            // Main ferm√©e si les distances sont petites
            return thumbIndexDist < 50 && palmMiddleDist < 120;
        }

        function handleHandMovement(landmarks, now) {
            if (now - lastMoveTime < MOVE_COOLDOWN) return;

            const palmCenter = landmarks[0]; // Centre de la paume
            
            if (!referenceHandPos) {
                referenceHandPos = { x: palmCenter[0], y: palmCenter[1] };
                return;
            }

            const dx = palmCenter[0] - referenceHandPos.x;
            const dy = palmCenter[1] - referenceHandPos.y;
            const threshold = 50; // pixels

            if (Math.abs(dx) > threshold || Math.abs(dy) > threshold) {
                // Inverser les d√©placements car l'image est miroir
                const panX = -dx * 2;
                const panY = dy * 2;

                map.panBy([panX, panY]);
                
                if (Math.abs(dx) > Math.abs(dy)) {
                    updateStatus(`üëã D√©placement ${dx > 0 ? 'droite' : 'gauche'}`);
                } else {
                    updateStatus(`üëã D√©placement ${dy > 0 ? 'bas' : 'haut'}`);
                }

                referenceHandPos = { x: palmCenter[0], y: palmCenter[1] };
                lastMoveTime = now;
            }
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // ============================================
        // FONCTIONS UTILITAIRES
        // ============================================

        function resetMap() {
            map.setView([48.8566, 2.3522], 5);
            updateStatus('Carte r√©initialis√©e');
        }

        function toggleDetection() {
            isDetecting = !isDetecting;
            updateStatus(isDetecting ? 'D√©tection activ√©e' : 'D√©tection en pause');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        // ============================================
        // INITIALISATION PRINCIPALE
        // ============================================

        async function init() {
            console.log('Initialisation...');
            
            // Initialiser la carte
            initMap();
            
            // Initialiser la cam√©ra
            const cameraOk = await initCamera();
            if (!cameraOk) {
                hideLoading();
                return;
            }

            // Charger le mod√®le
            const modelOk = await loadHandposeModel();
            if (!modelOk) {
                hideLoading();
                return;
            }

            // D√©marrer la d√©tection
            hideLoading();
            updateStatus('Pr√™t ! Montrez votre main √† la cam√©ra');
            detectHands();
        }

        // D√©marrer quand la page est charg√©e
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>